<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sign Up - GovLICA</title>
    <link rel="stylesheet" th:href="@{/css/govlica.css}"/>
</head>
<body>

<nav class="nav">
    <a href="/" class="nav-brand">GovLICA</a>
    <div class="nav-links">
        <a href="/">Home</a>
    </div>
</nav>

<main class="auth-container">
    <div class="auth-card">
        <h2>Sign Up</h2>
        <p class="auth-subtitle">GovLICA 계정 만들기</p>

        <div class="auth-alert auth-alert-error" id="errorMsg" style="display:none;"></div>
        <div class="auth-alert auth-alert-success" id="successMsg" style="display:none;"></div>

        <form id="signupForm" onsubmit="return handleSignup(event)">
            <div class="auth-form-group">
                <label for="email">Email</label>
                <input type="email" id="email" required placeholder="name@example.com" autofocus/>
            </div>
            <div class="auth-form-group">
                <label for="nickname">Nickname</label>
                <input type="text" id="nickname" required placeholder="Nickname" minlength="2" maxlength="20"/>
            </div>
            <div class="auth-form-group">
                <label for="password">Password</label>
                <input type="password" id="password" required placeholder="8자 이상" minlength="8"/>
            </div>
            <div class="auth-form-group">
                <label for="passwordConfirm">Confirm Password</label>
                <input type="password" id="passwordConfirm" required placeholder="비밀번호 확인"/>
            </div>
            <button type="submit" class="auth-btn" id="submitBtn">Sign Up</button>
        </form>

        <div class="auth-footer">
            <span>이미 계정이 있으신가요?</span>
            <a href="/user/login">Login</a>
        </div>
    </div>
</main>

<script th:src="@{/js/auth.js}"></script>
<script>
function handleSignup(e) {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    const errorMsg = document.getElementById('errorMsg');
    const successMsg = document.getElementById('successMsg');
    errorMsg.style.display = 'none';
    successMsg.style.display = 'none';

    const password = document.getElementById('password').value;
    const passwordConfirm = document.getElementById('passwordConfirm').value;
    if (password !== passwordConfirm) {
        errorMsg.textContent = '비밀번호가 일치하지 않습니다.';
        errorMsg.style.display = 'block';
        return false;
    }

    btn.disabled = true;
    btn.textContent = 'Signing up...';

    fetch('/api/auth/signup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            email: document.getElementById('email').value,
            nickname: document.getElementById('nickname').value,
            password: password
        })
    })
    .then(r => {
        if (!r.ok) return r.json().then(data => { throw new Error(data.message || 'Signup failed'); });
        return r.json();
    })
    .then(data => {
        successMsg.textContent = '회원가입 완료! 로그인 페이지로 이동합니다...';
        successMsg.style.display = 'block';
        setTimeout(() => { location.href = '/user/login'; }, 1500);
    })
    .catch(err => {
        errorMsg.textContent = err.message;
        errorMsg.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Sign Up';
    });

    return false;
}

if (Auth.isLoggedIn()) {
    location.href = '/';
}
</script>

</body>
</html>
